---
title: "activity3#"
author: "Madeleine Schoderbek"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
setwd("~/Documents/Biometry class/Biometry/activity 3")
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}

library(readxl)
library(dplyr)
library(tableone)
library(janitor)
library(openxlsx)
library(gtsummary)
library(kableExtra)
library(flextable)
library(officer)

rip <- read.xlsx(xlsxFile = "SuicideRisk_Data.xlsx")

# Convert variables to factors
rip <- rip %>%
  mutate(
    GENDER = factor(GENDER),
    RACE = factor(RACE),
    ETHNICITY = factor(ETHNICITY),
    HX_SUICIDE = factor(HX_SUICIDE, labels = c("No History", "History"))
  )

# Define variable list for Table 1
vars <- c("AGE", "GENDER", "RACE", "ETHNICITY", "INCOME",
          paste0("ACES___", 1:10),
          "CESDR_TOTAL_SUM",      # Depression scale
          "SABCS_TOTAL_SUM")      # Suicidal risk scale

# Identify categorical variables
factorVars <- c("GENDER", "RACE", "ETHNICITY", "INCOME")

# Create Table 1
table1 <- CreateTableOne(vars = vars,
                         strata = "HX_SUICIDE",
                         data = rip,
                         factorVars = factorVars,
                         includeNA = TRUE)

# -----------------------------
# Print table to data frame with Overall totals, tests, and effect sizes
# -----------------------------
table1_df <- print(table1,
                   showAllLevels = TRUE,
                   test = TRUE,
                   smd = TRUE,
                   addOverall = TRUE) %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "Characteristic")


table1_df$Characteristic <- c("n", "AGE..mean..SD..","GENDER","","RACE","","","ETHNICITY","", "INCOME", "", "", "", "", "ACES___1..mean..SD..", "ACES___2..mean..SD..", "ACES3..mean..SD..", "ACES4..mean..SD..", "ACES5..mean..SD..","ACES6..mean..SD..","ACES7..mean..SD..","ACES8..mean..SD..","ACES9..mean..SD..","ACES10..mean..SD..", "CESDR_TOTAL_SUM..mean..SD", "SABCS_TOTAL_SUM..mean..SD")



table1_df <- table1_df[, !duplicated(colnames(table1_df))]


# Rename the columns to match assignment requirements
colnames(table1_df) <- c("Characteristic",
                         "Total",
                         paste0("History of Suicide (n=", table(rip$HX_SUICIDE)["History"],")"),
                         paste0("No History of Suicide (n=", table(rip$HX_SUICIDE)["No History"],")"),
                         "Effect Size",
                         "P-value")

table1_df$`Effect Size` <- round(as.numeric(table1_df$`Effect Size`), 2)
table1_df$`P-value` <- signif(as.numeric(table1_df$`P-value`), 3)

# Format for Word output

ft <- flextable(table1_df) %>%
  autofit() %>%
  set_caption(caption = "Table 1: Demographic and Mental Health Characteristics (n = 546)") %>%
  theme_vanilla() %>%
  footnote(
    i = 1, j = 1,
    value = as_paragraph("Note: ACE = Adverse Childhood Experience; CES-DR = Depression scale; SABCS = Suicidal Affect-Behavior-Cognition Scale. Continuous variables compared using t-test; categorical variables compared using Chi-square test."),
    ref_symbols = " "
  )

doc <- read_docx()
doc <- body_add_flextable(doc, ft)
print(doc, target = "Table1_SuicideRisk.docx")

# Add footnotes as text in R Markdown (after the table)
cat("**Note:** ACE = Adverse Childhood Experience; CES-DR = Depression scale; SABCS = Suicidal Affect-Behavior-Cognition Scale. Continuous variables compared using t-test; categorical variables compared using Chi-square test.")




```
```{r}
# Install/load packages

# Set CRAN mirror first
options(repos = c(CRAN = "https://cran.rstudio.com/"))

install.packages(c("tidyverse", "readxl", "gtsummary", "gt", "effectsize"))
library(tidyverse)
library(readxl)
library(gtsummary)
library(gt)
library(effectsize)
library(openxlsx)
library(flextable)
library(officer)


# 1. Import dataset
rip <- read.xlsx(xlsxFile = "SuicideRisk_Data.xlsx")
# 2. Convert relevant variables
rip <- rip %>%
  mutate(
    GENDER = factor(GENDER),
    RACE = factor(RACE),
    ETHNICITY = factor(ETHNICITY),
    HX_SUICIDE = factor(HX_SUICIDE, labels = c("No History", "History"))
  )

# 3. Rename ACEs for clarity (replace with actual descriptions from your dictionary)
rip <- rip %>%
  rename(
    ACE1_PhysicalAbuse = ACES___1,
    ACE2_SexualAbuse = ACES___2,
    ACE3_EmotionalAbuse = ACES___3,
    ACE4_Neglect = ACES___4,
    ACE5_HouseholdSubstance = ACES___5,
    ACE6_HouseholdMentalIllness = ACES___6,
    ACE7_DomesticViolence = ACES___7,
    ACE8_ParentalSeparation = ACES___8,
    ACE9_IncarceratedHouseholdMember = ACES___9,
    ACE10_OtherTrauma = ACES___10
  )


effect_sizes <- data.frame(
  variable = c("AGE","GENDER","RACE","ETHNICITY","INCOME",
               paste0("ACE",1:10),
               "CESDR_TOTAL_SUM","SABCS_TOTAL_SUM"),
  effect_size = c(
    cohens_d(AGE ~ HX_SUICIDE, data=rip)$Cohens_d,
    cramers_v(rip$GENDER, rip$HX_SUICIDE),
    cramers_v(rip$RACE, rip$HX_SUICIDE),
    cramers_v(rip$ETHNICITY, rip$HX_SUICIDE),
    cramers_v(rip$INCOME, rip$HX_SUICIDE),
    rep(NA,10),  # ACEs optional if binary
    cohens_d(CESDR_TOTAL_SUM ~ HX_SUICIDE, data=rip)$Cohens_d,
    cohens_d(SABCS_TOTAL_SUM ~ HX_SUICIDE, data=rip)$Cohens_d
  )
)

# 4. Create Table 1 with gtsummary
table1 <- rip %>%
  tbl_summary(
    by = HX_SUICIDE,
    statistic = list(
      all_continuous() ~ "{mean} ± {sd}",
      all_categorical() ~ "{n} ({p}%)"
    ),
    missing = "no"
  ) %>%
  add_overall() %>%
  add_p() %>%
  modify_header(label = "Characteristic") %>%
  modify_caption("**Table 1: Demographic and Mental Health Characteristics (n = 546)**") %>%
  add_stat_label()

# Add effect sizes to table (clean + correct)

table1 <- table1 %>%
  modify_table_body(
    ~ .x %>%
      left_join(effect_sizes, by = "variable") %>%
      rename(`Effect Size` = effect_size)
  )

# Note: Add these effect sizes manually to the "Effect Size" column in the gtsummary table

# 6. Export table to Word with title and footnotes
save_as_docx(
  "Table 1" = table1 %>% as_flex_table(),
  path = "Table1_SuicideRisk.docx"
)


```












```{r}
# -----------------------------
# Load libraries
# -----------------------------
library(readxl)
library(dplyr)
library(tableone)
library(janitor)
library(openxlsx)
library(flextable)
library(officer)
library(effectsize)

# -----------------------------
# Import dataset
# -----------------------------
rip <- read.xlsx(xlsxFile = "SuicideRisk_Data.xlsx")

# -----------------------------
# Convert variables to factors
# -----------------------------
rip <- rip %>%
  mutate(
    GENDER = factor(GENDER),
    RACE = factor(RACE),
    ETHNICITY = factor(ETHNICITY),
    INCOME = factor(INCOME),
    HX_SUICIDE = factor(HX_SUICIDE, labels = c("No History", "History"))
  )

# -----------------------------
# Define variables for Table 1
# -----------------------------
vars <- c("AGE", "GENDER", "RACE", "ETHNICITY", "INCOME",
          paste0("ACES___", 1:10),
          "CESDR_TOTAL_SUM",      # Depression scale
          "SABCS_TOTAL_SUM")      # Suicidal risk scale

factorVars <- c("GENDER", "RACE", "ETHNICITY", "INCOME") # categorical
contVars <- c("AGE", paste0("ACES___", 1:10), "CESDR_TOTAL_SUM", "SABCS_TOTAL_SUM") # continuous

# -----------------------------
# Create Table 1
# -----------------------------
table1 <- CreateTableOne(vars = vars,
                         strata = "HX_SUICIDE",
                         data = rip,
                         factorVars = factorVars,
                         includeNA = TRUE)

# -----------------------------
# Print table to data frame
# -----------------------------
table1_df <- print(table1,
                   showAllLevels = TRUE,
                   test = TRUE,
                   smd = TRUE,
                   addOverall = TRUE) %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "Characteristic")

cols_exist <- c("Characteristic", "Overall", "History", "NoHistory", "Std..Mean.Diff", "p.value")

cols_keep <- cols_exist[cols_exist %in% colnames(table1_df)]
table1_df <- table1_df[, cols_keep]

# Rename columns explicitly
names(table1_df) <- c("Characteristic", "Total", "History of Suicide", "No History of Suicide", "Effect Size", "P-value")[1:ncol(table1_df)]

# Replace NA with "" to avoid errors
table1_df[is.na(table1_df)] <- ""

table1_df$Characteristic <- gsub("\\.\\.mean\\.\\.SD.*", "", table1_df$Characteristic)
table1_df$Characteristic <- gsub("ACES___", "ACES ", table1_df$Characteristic)
table1_df$Characteristic <- gsub("CESDR_TOTAL_SUM", "Depression (CES-DR)", table1_df$Characteristic)
table1_df$Characteristic <- gsub("SABCS_TOTAL_SUM", "Suicidal Risk (SABCS)", table1_df$Characteristic)


for (v in contVars) {
  row_index <- grep(v, table1_df$Characteristic)
  if (length(row_index) == 0) next
  
  # Overall
  mean_val <- mean(rip[[v]], na.rm = TRUE)
  se <- sd(rip[[v]], na.rm = TRUE)/sqrt(sum(!is.na(rip[[v]])))
  table1_df$Overall[row_index] <- paste0(round(mean_val,2), " ± ", round(1.96*se,2))
  
  # Group-wise
  for (group in levels(rip$HX_SUICIDE)) {
    subset_data <- rip[rip$HX_SUICIDE == group, v]
    mean_g <- mean(subset_data, na.rm = TRUE)
    se_g <- sd(subset_data, na.rm = TRUE)/sqrt(sum(!is.na(subset_data)))
    ci_g <- paste0(round(mean_g,2), " ± ", round(1.96*se_g,2))
    
    col_name <- ifelse(group=="History", "History", "NoHistory")
    table1_df[row_index, col_name] <- ci_g
  }
}
table1_df$EffectSize <- ifelse("Std..Mean.Diff" %in% colnames(table1_df), table1_df$Std..Mean.Diff, "")
table1_df$Pvalue <- ifelse("p.value" %in% colnames(table1_df), table1_df$p.value, "")

# Clean numeric formatting
table1_df$EffectSize <- ifelse(grepl("^[0-9\\.]+$", table1_df$EffectSize),
                               round(as.numeric(table1_df$EffectSize),2),
                               table1_df$EffectSize)
table1_df$Pvalue <- ifelse(grepl("^[0-9\\.]+$", table1_df$Pvalue),
                           signif(as.numeric(table1_df$Pvalue),3),
                           table1_df$Pvalue)

# -----------------------------
# Add/rename columns explicitly for flextable
# -----------------------------
table1_df <- table1_df[, c("Characteristic", "Overall", "History", "NoHistory", "EffectSize", "Pvalue")]
colnames(table1_df) <- c("Characteristic", "Total", "History of Suicide", "No History of Suicide", "Effect Size", "P-value")

ft <- flextable(table1_df) %>%
  autofit() %>%
  set_caption("Table 1: Demographic and Mental Health Characteristics (n = 546)") %>%
  theme_vanilla() %>%
  footnote(i = 1, j = 1,
           value = as_paragraph("Note: ACE = Adverse Childhood Experience; CES-DR = Depression scale; SABCS = Suicidal Affect-Behavior-Cognition Scale. Continuous variables compared using t-test; categorical variables compared using Chi-square test."),
           ref_symbols = " ")

# -----------------------------
# Export to Word
# -----------------------------
doc <- read_docx()
doc <- body_add_flextable(doc, ft)
print(doc, target = "Table1_SuicideRisk.docx")
```



